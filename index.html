<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>„Å®„Åë„ÅÑ„ÅÆ„Åæ„Å°„ÅÆ „Åò„Åã„Çì„Åü„Çì„Å¶„ÅÑ</title>
  
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>

  <style>
    body { margin: 0; overflow-x: hidden; }
    .app-container {
      text-align: center;
      font-family: 'Hiragino Maru Gothic ProN', 'Rounded M+ 1c', sans-serif;
      background-color: #f0f8ff;
      min-height: 100vh;
      padding: 20px;
      color: #333;
      position: relative;
    }
    h1, h2 { color: #ff6b6b; text-shadow: 2px 2px 0px #fff; margin-top: 10px; }
    .status-bar {
      background: #fff; padding: 10px 20px; border-radius: 20px;
      display: inline-block; font-size: 24px; font-weight: bold;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px;
    }
    .menu-buttons { display: flex; flex-direction: column; gap: 20px; align-items: center; margin-top: 20px; }
    .btn {
      background-color: #4ecdc4; color: white; border: none; border-radius: 50px;
      padding: 15px 40px; font-size: 22px; font-weight: bold; cursor: pointer;
      box-shadow: 0 5px 0 #3b9b95; transition: all 0.1s; width: 85%; max-width: 400px;
    }
    .btn:active { transform: translateY(5px); box-shadow: none; }
    .btn.orange { background-color: #ff9f43; box-shadow: 0 5px 0 #cc7d30; }
    .btn.purple { background-color: #a29bfe; box-shadow: 0 5px 0 #6c5ce7; }
    .btn.gray { background-color: #ccc; box-shadow: 0 5px 0 #999; cursor: not-allowed; }
    
    .clock-container {
      margin: 10px auto; width: 220px; height: 220px; background: white;
      border-radius: 50%; box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    .clock-hand { transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); }

    .choices { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-top: 15px; }
    .choice-btn {
      background: #fff; border: 3px solid #4ecdc4; color: #333; font-size: 20px;
      font-weight: bold; padding: 12px 15px; border-radius: 15px; cursor: pointer;
      width: 140px; box-shadow: 0 4px 0 #4ecdc4;
    }
    .choice-btn:active { transform: translateY(4px); box-shadow: none; }

    .controls { display: flex; justify-content: center; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
    .control-btn {
      background: #ffeaa7; border: 2px solid #fdcb6e; color: #d63031;
      font-size: 18px; font-weight: bold; padding: 10px 15px; border-radius: 10px;
      cursor: pointer; box-shadow: 0 3px 0 #fdcb6e;
    }
    .control-btn:active { transform: translateY(3px); box-shadow: none; }

    .notebook {
      background: #fff9c4; border: 5px solid #ffcc80; border-radius: 10px;
      padding: 20px; max-width: 500px; margin: 20px auto; min-height: 200px;
    }
    .sticker-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(50px, 1fr)); gap: 10px; margin-top: 20px; }
    .sticker {
      font-size: 36px; background: white; border-radius: 50%; width: 50px; height: 50px;
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1); animation: pop 0.3s ease-out;
    }
    @keyframes pop { 0% { transform: scale(0); } 80% { transform: scale(1.2); } 100% { transform: scale(1); } }
    .message { font-size: 20px; font-weight: bold; color: #ff6b6b; min-height: 30px; margin: 10px 0; }

    .success-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      pointer-events: none; display: flex; align-items: center; justify-content: center;
      z-index: 1000; background: rgba(255, 255, 255, 0.6);
    }
    .hanamaru {
      font-size: 180px; text-shadow: 0 0 20px #ffcc80;
      animation: stamp 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
    }
    @keyframes stamp {
      0% { transform: scale(5) rotate(-30deg); opacity: 0; }
      100% { transform: scale(1) rotate(0deg); opacity: 1; }
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    const STICKER_LIST = [
      "üê∂", "üê±", "üê≠", "üêπ", "üê∞", "ü¶ä", "üêª", "üêº", "üê®", "üêØ", 
      "ü¶Å", "üêÆ", "üê∑", "üê∏", "üêµ", "üêß", "üê¶", "üê§", "ü¶â", "ü¶Ñ",
      "üçé", "üçå", "üçá", "üçì", "üçâ", "üçî", "üçï", "üç©", "üç¶", "üç∞",
      "üöó", "üöì", "üöí", "üöë", "üöÄ", "üõ∏", "üíé", "üëë", "‚öΩÔ∏è", "üé∏"
    ];

    // --- Èü≥„ÇíÈ≥¥„Çâ„Åô„Åü„ÇÅ„ÅÆ‰ªïÁµÑ„Åø (Web Audio API) ---
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    let audioCtx;

    // Âü∫Êú¨„ÅÆÈü≥‰Ωú„ÇäÈñ¢Êï∞
    const playTone = (freq, type, duration, startTimeOffset) => {
      if (!audioCtx) audioCtx = new AudioContext();
      if (audioCtx.state === 'suspended') audioCtx.resume();
      
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      
      osc.type = type;
      osc.frequency.setValueAtTime(freq, audioCtx.currentTime + startTimeOffset);
      
      // Èü≥Èáè„ÇíÂ∞ë„Åó„Åö„Å§‰∏ã„Åí„Å¶Ëá™ÁÑ∂„Å´Ê∂à„Åà„Çã„Çà„ÅÜ„Å´„Åô„Çã
      gain.gain.setValueAtTime(0.1, audioCtx.currentTime + startTimeOffset);
      gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + startTimeOffset + duration);
      
      osc.connect(gain);
      gain.connect(audioCtx.destination);
      
      osc.start(audioCtx.currentTime + startTimeOffset);
      osc.stop(audioCtx.currentTime + startTimeOffset + duration);
    };

    // Áî®ÈÄîÂà•„ÅÆÂäπÊûúÈü≥
    const sounds = {
      click: () => {
        playTone(800, 'sine', 0.05, 0); // „Éî„ÉÉ
      },
      correct: () => {
        playTone(523.25, 'sine', 0.1, 0);      // „Éâ
        playTone(659.25, 'sine', 0.1, 0.1);    // „Éü
        playTone(783.99, 'sine', 0.3, 0.2);    // „ÇΩ
      },
      wrong: () => {
        playTone(150, 'sawtooth', 0.3, 0);     // „Éñ„ÉÉ
        playTone(150, 'sawtooth', 0.3, 0.4);   // „Éñ„Éº
      },
      gacha: () => {
        playTone(440, 'square', 0.1, 0);       // „É©
        playTone(554.37, 'square', 0.1, 0.1);  // „Éâ#
        playTone(659.25, 'square', 0.1, 0.2);  // „Éü
        playTone(880, 'square', 0.4, 0.3);     // È´ò„ÅÑ„É©
      }
    };
    // ------------------------------------------

    const calcTime = (totalMinutes) => {
      while (totalMinutes < 0) totalMinutes += 12 * 60;
      const h = Math.floor(totalMinutes / 60) % 12;
      const m = totalMinutes % 60;
      return { hour: h === 0 ? 12 : h, minute: m };
    };

    const Clock = ({ totalMinutes }) => {
      const hourAngle = totalMinutes * 0.5;
      const minuteAngle = totalMinutes * 6;

      return (
        <div className="clock-container">
          <svg viewBox="0 0 100 100" width="100%" height="100%">
            <circle cx="50" cy="50" r="48" fill="white" stroke="#ffb8b8" strokeWidth="4" />
            {[...Array(12)].map((_, i) => {
              const num = i + 1;
              const angle = (num * 30 - 90) * (Math.PI / 180);
              const x = 50 + 35 * Math.cos(angle);
              const y = 50 + 35 * Math.sin(angle);
              return <text key={num} x={x} y={y} fontSize="10" fill="#ff6b6b" fontWeight="bold" textAnchor="middle" dominantBaseline="central">{num}</text>;
            })}
            {[...Array(60)].map((_, i) => {
              if (i % 5 === 0) return null;
              const angle = (i * 6 - 90) * (Math.PI / 180);
              const x = 50 + 44 * Math.cos(angle);
              const y = 50 + 44 * Math.sin(angle);
              return <circle key={`dot-${i}`} cx={x} cy={y} r="0.5" fill="#a0d2eb" />;
            })}
            <line className="clock-hand" x1="50" y1="50" x2="50" y2="25" stroke="#ff6b6b" strokeWidth="4" strokeLinecap="round" transform={`rotate(${hourAngle} 50 50)`} />
            <line className="clock-hand" x1="50" y1="50" x2="50" y2="15" stroke="#4ecdc4" strokeWidth="3" strokeLinecap="round" transform={`rotate(${minuteAngle} 50 50)`} />
            <circle cx="50" cy="50" r="3" fill="#333" />
          </svg>
        </div>
      );
    };

    function App() {
      const [view, setView] = useState('home');
      const [gears, setGears] = useState(() => parseInt(localStorage.getItem('gears')) || 0);
      const [stickers, setStickers] = useState(() => JSON.parse(localStorage.getItem('stickers')) || []);
      
      const [question, setQuestion] = useState(null);
      const [message, setMessage] = useState('');
      const [mistakeCount, setMistakeCount] = useState(0);
      const [showSuccess, setShowSuccess] = useState(false);
      const [interactiveMinutes, setInteractiveMinutes] = useState(0);

      useEffect(() => {
        localStorage.setItem('gears', gears);
        localStorage.setItem('stickers', JSON.stringify(stickers));
      }, [gears, stickers]);

      const triggerSuccess = () => {
        sounds.correct(); // Ê≠£Ëß£Èü≥„ÇíÈ≥¥„Çâ„Åô
        setShowSuccess(true);
        setTimeout(() => setShowSuccess(false), 1500);
      };

      // ---------------- „É¢„Éº„Éâ1 ----------------
      const generateReadQuestion = () => {
        const totalMin = Math.floor(Math.random() * 12) * 60 + Math.floor(Math.random() * 12) * 5;
        const correctTime = calcTime(totalMin);
        const correctAns = `${correctTime.hour}„Åò ${correctTime.minute}„Åµ„Çì`;
        
        const wrongTime1 = calcTime(totalMin + 15);
        const wrongTime2 = calcTime(totalMin + 60);
        const choices = [
          correctAns,
          `${wrongTime1.hour}„Åò ${wrongTime1.minute}„Åµ„Çì`,
          `${wrongTime2.hour}„Åò ${correctTime.minute}„Åµ„Çì`
        ].sort(() => Math.random() - 0.5);
        
        setQuestion({ totalMinutes: totalMin, correct: correctAns, choices });
        setMessage('„Å™„Çì„Åò „Å™„Çì„Å∑„Çì „Åã„Å™Ôºü');
      };

      const startReadGame = () => {
        sounds.click();
        setMistakeCount(0);
        generateReadQuestion();
        setView('game-read');
      };

      const handleReadAnswer = (choice) => {
        if (choice === question.correct) {
          setMessage('Â§ß„Åõ„ÅÑ„Åã„ÅÑÔºÅ „ÅØ„Åê„Çã„Åæ„Ç≤„ÉÉ„ÉàÔºÅ ‚öôÔ∏è');
          triggerSuccess();
          setGears(g => g + 1);
          setMistakeCount(0);
          setTimeout(() => generateReadQuestion(), 1500);
        } else {
          sounds.wrong(); // ‰∏çÊ≠£Ëß£Èü≥„ÇíÈ≥¥„Çâ„Åô
          const newMistakes = mistakeCount + 1;
          if (newMistakes >= 3) {
            setGears(g => Math.max(0, g - 1));
            setMistakeCount(0);
            setMessage('3„Åã„ÅÑ „Åæ„Å°„Åå„Åà„ÅüÔºÅ „ÅØ„Åê„Çã„Åæ1„Åì „Åº„Å£„Åó„ÇÖ„ÅÜ üò≠ „Åπ„Å§„ÅÆ„ÇÇ„Çì„Å†„ÅÑ„Å´„Åô„Çã„Å≠');
          } else {
            setMistakeCount(newMistakes);
            setMessage(`„Åñ„Çì„Å≠„ÇìÔºÅ„Å°„Åå„ÅÜ„ÇÇ„Çì„Å†„ÅÑ„Å´„Åô„Çã„Çà (${newMistakes}„Åã„ÅÑ „Éü„Çπ)`);
          }
          setTimeout(() => generateReadQuestion(), 2000);
        }
      };

      // ---------------- „É¢„Éº„Éâ2 ----------------
      const generateMoveQuestion = () => {
        const startTotalMin = Math.floor(Math.random() * 12) * 60 + (Math.floor(Math.random() * 4) * 15);
        const offsets = [10, 15, 20, 30, 60, -10, -15, -20, -30, -60];
        const offset = offsets[Math.floor(Math.random() * offsets.length)];
        const targetTotalMin = startTotalMin + offset;
        
        setQuestion({ startTotal: startTotalMin, offset: offset, targetTotal: targetTotalMin });
        setInteractiveMinutes(startTotalMin);
        
        let offsetText = offset > 0 ? `${offset}„Å∑„Çì „Åî` : `${Math.abs(offset)}„Å∑„Çì „Åæ„Åà`;
        if(offset === 60) offsetText = "1„Åò„Åã„Çì „Åî";
        if(offset === -60) offsetText = "1„Åò„Åã„Çì „Åæ„Åà";

        const startTime = calcTime(startTotalMin);
        setMessage(`„ÅÑ„Åæ„ÅØ ${startTime.hour}„Åò ${startTime.minute}„Åµ„Çì„ÄÇ„Äå${offsetText}„Äç„ÅØ „Å™„Çì„ÅòÔºü`);
      };

      const startMoveGame = () => {
        sounds.click();
        setMistakeCount(0);
        generateMoveQuestion();
        setView('game-move');
      };

      const moveClock = (minutes) => {
        sounds.click(); // ÊôÇË®à„ÇíÂãï„Åã„ÅôÈü≥„ÇíÈ≥¥„Çâ„Åô
        setInteractiveMinutes(prev => prev + minutes);
      };

      const checkMoveAnswer = () => {
        const isCorrect = (interactiveMinutes % 720 + 720) % 720 === (question.targetTotal % 720 + 720) % 720;
        
        if (isCorrect) {
          triggerSuccess();
          setMessage('Â§ß„Åõ„ÅÑ„Åã„ÅÑÔºÅ „Çø„Ç§„É†„Éà„É©„Éô„É´ „Åõ„ÅÑ„Åì„ÅÜÔºÅ ‚öôÔ∏è„Ç≤„ÉÉ„ÉàÔºÅ');
          setGears(g => g + 1);
          setMistakeCount(0);
          setTimeout(() => generateMoveQuestion(), 1500);
        } else {
          sounds.wrong(); // ‰∏çÊ≠£Ëß£Èü≥„ÇíÈ≥¥„Çâ„Åô
          const newMistakes = mistakeCount + 1;
          if (newMistakes >= 3) {
            setGears(g => Math.max(0, g - 1));
            setMistakeCount(0);
            setMessage('3„Åã„ÅÑ „Åæ„Å°„Åå„Åà„ÅüÔºÅ „ÅØ„Åê„Çã„Åæ1„Åì „Åº„Å£„Åó„ÇÖ„ÅÜ üò≠ „Åπ„Å§„ÅÆ„Åò„Å†„ÅÑ„Å∏ „ÅÑ„Åè„Çà');
            setTimeout(() => generateMoveQuestion(), 2000);
          } else {
            setMistakeCount(newMistakes);
            setMessage(`„Åä„Åó„ÅÑÔºÅ „ÇÇ„ÅÜ„Åô„Åì„Åó „Åê„Çã„Åê„Çã„Åó„Å¶„Åø„Çà„ÅÜ (${newMistakes}„Åã„ÅÑ „Éü„Çπ)`);
          }
        }
      };

      // ---------------- „Ç¨„ÉÅ„É£ ----------------
      const spinGacha = () => {
        if (gears >= 10) {
          sounds.gacha(); // „Ç¨„ÉÅ„É£„ÅÆÈü≥„ÇíÈ≥¥„Çâ„Åô
          setGears(g => g - 10);
          const randomSticker = STICKER_LIST[Math.floor(Math.random() * STICKER_LIST.length)];
          setStickers([...stickers, randomSticker]);
          setMessage(`„Äå${randomSticker}„Äç„Åå „Åß„Åü„ÇàÔºÅ`);
        } else {
          sounds.wrong();
        }
      };

      return (
        <div className="app-container">
          {showSuccess && <div className="success-overlay"><div className="hanamaru">üíÆ</div></div>}

          <div className="status-bar">‚öôÔ∏è „ÅØ„Åê„Çã„Åæ: {gears}„Åì</div>
          
          {view === 'home' && (
            <div>
              <h1>„Åò„Åã„Çì„Åü„Çì„Å¶„ÅÑ</h1>
              <div className="menu-buttons">
                <button className="btn" onClick={startReadGame}>‚ë† „Å®„Åë„ÅÑ„Çí „Çà„ÇÄ</button>
                <button className="btn purple" onClick={startMoveGame}>‚ë° „Çø„Ç§„É†„Éà„É©„Éô„É´ („Å™„Çì„Å∑„Çì„ÅîÔºü)</button>
                <button className="btn orange" onClick={() => { sounds.click(); setView('notebook'); setMessage(''); }}>„Ç∑„Éº„É´„Å¶„Å°„Çá„ÅÜ</button>
              </div>
            </div>
          )}

          {view === 'game-read' && question && (
            <div>
              <h2>„ÅÑ„Åæ „Å™„Çì„ÅòÔºü</h2>
              <div className="message">{message}</div>
              <Clock totalMinutes={question.totalMinutes} />
              <div className="choices">
                {question.choices.map((choice, i) => (
                  <button key={i} className="choice-btn" onClick={() => handleReadAnswer(choice)}>{choice}</button>
                ))}
              </div>
              <div style={{ marginTop: '20px' }}>
                <button className="btn orange" style={{ fontSize: '18px', padding: '10px 20px' }} onClick={() => { sounds.click(); setView('home'); }}>„ÇÇ„Å©„Çã</button>
              </div>
            </div>
          )}

          {view === 'game-move' && question && (
            <div>
              <h2>„Çø„Ç§„É†„Éà„É©„Éô„É´ÔºÅ</h2>
              <div className="message" style={{ fontSize: '18px' }}>{message}</div>
              <Clock totalMinutes={interactiveMinutes} />
              <div className="controls">
                <button className="control-btn" onClick={() => moveClock(-60)}>‚è™ 1„Åò„Åã„Çì</button>
                <button className="control-btn" onClick={() => moveClock(-5)}>‚óÅ 5„Åµ„Çì</button>
                <button className="control-btn" onClick={() => moveClock(5)}>5„Åµ„Çì ‚ñ∑</button>
                <button className="control-btn" onClick={() => moveClock(60)}>1„Åò„Åã„Çì ‚è©</button>
              </div>
              <div style={{ marginTop: '20px' }}>
                <button className="btn" onClick={checkMoveAnswer} style={{ width: '100%', maxWidth: '250px' }}>„Åì„Çå„Å†ÔºÅ</button>
              </div>
              <div style={{ marginTop: '20px' }}>
                <button className="btn orange" style={{ fontSize: '18px', padding: '10px 20px' }} onClick={() => { sounds.click(); setView('home'); }}>„ÇÇ„Å©„Çã</button>
              </div>
            </div>
          )}

          {view === 'notebook' && (
            <div>
              <h2>„Åü„Çì„Å¶„ÅÑ „Ç∑„Éº„É´„Å¶„Å°„Çá„ÅÜ</h2>
              <div className="message">{message}</div>
              <button className={`btn ${gears < 10 ? 'gray' : ''}`} onClick={spinGacha} disabled={gears < 10}>
                {gears >= 10 ? '„Ç¨„ÉÅ„É£„Çí„Åæ„Çè„Åô (‚öôÔ∏è10„Åì)' : '„ÅØ„Åê„Çã„Åæ„Åå „Åü„Çä„Å™„ÅÑ„Çà'}
              </button>
              <div className="notebook">
                <p>„ÅÇ„Å§„ÇÅ„Åü„Ç∑„Éº„É´: {stickers.length}„Åæ„ÅÑ</p>
                <div className="sticker-grid">
                  {stickers.map((sticker, i) => <div key={i} className="sticker">{sticker}</div>)}
                </div>
              </div>
              <div style={{ marginTop: '20px' }}>
                <button className="btn orange" style={{ fontSize: '18px', padding: '10px 20px' }} onClick={() => { sounds.click(); setView('home'); }}>„ÇÇ„Å©„Çã</button>
              </div>
            </div>
          )}
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
