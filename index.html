<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ã¨ã‘ã„ã®ã¾ã¡ã® ã˜ã‹ã‚“ãŸã‚“ã¦ã„</title>
  
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>

  <style>
    /* å…¨ä½“ã®ã‚¹ã‚¿ã‚¤ãƒ«ãƒ»èƒŒæ™¯ã®æœæ˜¼å¤œ */
    body { margin: 0; overflow-x: hidden; touch-action: manipulation; user-select: none; }
    .app-container {
      text-align: center; font-family: 'Hiragino Maru Gothic ProN', 'Rounded M+ 1c', sans-serif;
      min-height: 100vh; padding: 15px; color: #333; transition: background 1s ease;
    }
    .bg-morning { background: linear-gradient(to bottom, #8ee4af, #edf5e1); }
    .bg-day { background: linear-gradient(to bottom, #74b9ff, #dfe6e9); }
    .bg-sunset { background: linear-gradient(to bottom, #ff9ff3, #feca57); }
    .bg-night { background: linear-gradient(to bottom, #2c3e50, #34495e); color: white; }
    
    h1 { color: #fff; text-shadow: 0 4px 6px rgba(0,0,0,0.2), 0 0 10px #ff9f43; font-size: 28px; margin-top: 10px; }
    .status-bar {
      background: rgba(255,255,255,0.9); padding: 8px 15px; border-radius: 20px; color: #333;
      display: inline-flex; align-items: center; gap: 15px; font-size: 20px; font-weight: bold;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 15px;
    }
    .combo-text { color: #ff4757; animation: bounce 0.5s infinite alternate; }

    /* ãƒ›ãƒ¼ãƒ ç”»é¢ã®ã‚ªã‚·ãƒ£ãƒ¬ãªãƒœã‚¿ãƒ³ç¾¤ */
    .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; max-width: 500px; margin: 0 auto; }
    .menu-btn {
      border: none; border-radius: 15px; padding: 15px 5px; font-size: 16px; font-weight: bold;
      color: white; cursor: pointer; box-shadow: 0 6px 0 rgba(0,0,0,0.2); transition: transform 0.1s;
      display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 5px;
    }
    .menu-btn:active { transform: translateY(6px); box-shadow: none; }
    .btn-easy { background: #78e08f; }
    .btn-read1 { background: #38ada9; }
    .btn-read2 { background: #0a3d62; }
    .btn-move1 { background: #82ccdd; }
    .btn-move2 { background: #60a3bc; }
    .btn-attack { background: #e55039; grid-column: span 2; font-size: 18px; }
    .btn-book { background: #f6b93b; grid-column: span 2; font-size: 18px; color: #333; }
    .btn-reset { background: #7f8c8d; grid-column: span 2; padding: 10px; font-size: 14px; margin-top: 20px;}
    
    /* æ™‚è¨ˆå‘¨ã‚Š */
    .clock-container {
      margin: 10px auto; width: 220px; height: 220px; background: white;
      border-radius: 50%; box-shadow: 0 10px 20px rgba(0,0,0,0.2); position: relative;
    }
    .clock-hand { transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
    .clock-hint { fill: #b2bec3; font-size: 6px; font-weight: bold; }

    /* UIãƒ‘ãƒ¼ãƒ„ */
    .message-box {
      background: rgba(255,255,255,0.85); color: #2d3436; padding: 10px; border-radius: 10px;
      font-size: 18px; font-weight: bold; min-height: 28px; margin-bottom: 10px; max-width: 400px; margin-left: auto; margin-right: auto;
    }
    .btn-back { background: #ff7f50; color: white; border: none; padding: 10px 30px; border-radius: 20px; font-size: 18px; font-weight: bold; box-shadow: 0 4px 0 #cd6133; margin-top: 20px; cursor: pointer;}
    .btn-back:active { transform: translateY(4px); box-shadow: none; }

    /* é¸æŠè‚¢ãƒ»ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« */
    .choices { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; }
    .choice-btn { background: #fff; border: 3px solid #4ecdc4; font-size: 20px; font-weight: bold; padding: 10px 15px; border-radius: 15px; cursor: pointer; width: 130px; box-shadow: 0 4px 0 #4ecdc4; }
    .choice-btn:active { transform: translateY(4px); box-shadow: none; }
    .controls { display: flex; justify-content: center; gap: 5px; flex-wrap: wrap; margin-bottom: 10px; }
    .control-btn { background: #ffeaa7; border: 2px solid #fdcb6e; color: #d63031; font-size: 16px; font-weight: bold; padding: 8px 10px; border-radius: 10px; cursor: pointer; box-shadow: 0 3px 0 #fdcb6e; }
    .control-btn:active { transform: translateY(3px); box-shadow: none; }
    .btn-hint { background: #ffeaa7; border: none; border-radius: 15px; padding: 5px 15px; font-weight: bold; box-shadow: 0 3px 0 #fdcb6e; margin-bottom: 10px; cursor: pointer; }

    /* ãƒ†ãƒ³ã‚­ãƒ¼ï¼ˆNumpadï¼‰ */
    .numpad-container { max-width: 300px; margin: 0 auto; background: rgba(255,255,255,0.9); padding: 15px; border-radius: 15px; }
    .input-display { display: flex; justify-content: center; gap: 10px; margin-bottom: 10px; font-size: 24px; font-weight: bold; color: #333; }
    .input-box { width: 60px; height: 40px; border: 3px solid #ccc; border-radius: 10px; display: flex; align-items: center; justify-content: center; background: white; cursor: pointer; }
    .input-box.active { border-color: #ff4757; background: #ffeaa7; }
    .numpad-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
    .num-key { background: #dfe6e9; border: none; border-radius: 10px; padding: 10px; font-size: 20px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 0 #b2bec3; }
    .num-key:active { transform: translateY(4px); box-shadow: none; }
    .num-key.action { background: #74b9ff; color: white; box-shadow: 0 4px 0 #0984e3; }
    .num-key.submit { background: #00b894; color: white; box-shadow: 0 4px 0 #00b894; grid-column: span 3; }

    /* æ‰‹å¸³ã¨ã‚·ãƒ¼ãƒ« */
    .notebook { background: #fff9c4; border: 5px solid #ffcc80; border-radius: 10px; padding: 15px; max-width: 500px; margin: 0 auto; min-height: 200px; }
    .sticker-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(45px, 1fr)); gap: 8px; margin-top: 15px; }
    .sticker { font-size: 28px; background: white; border-radius: 50%; width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
    .sticker.N { border: 2px solid #ccc; }
    .sticker.R { border: 3px solid #c0c0c0; background: linear-gradient(135deg, #f5f7fa, #c3cfe2); box-shadow: 0 0 10px silver; }
    .sticker.SR { border: 3px solid #ffd700; background: linear-gradient(135deg, #fff9c4, #ffc107); box-shadow: 0 0 15px gold; }
    .locked-sticker { background: rgba(0,0,0,0.1); font-size: 16px; color: rgba(0,0,0,0.2); border: 2px dashed #ccc; }

    /* ãƒ‰æ´¾æ‰‹æ¼”å‡º */
    .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: flex; align-items: center; justify-content: center; z-index: 1000; }
    .hanamaru { font-size: 180px; text-shadow: 0 0 20px #ffcc80; animation: stamp 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
    @keyframes stamp { 0% { transform: scale(5) rotate(-30deg); opacity: 0; } 100% { transform: scale(1) rotate(0deg); opacity: 1; } }
    @keyframes bounce { 0% { transform: scale(1); } 100% { transform: scale(1.1); } }
    
    /* ã‚¬ãƒãƒ£æ¼”å‡ºç”¨ */
    .gacha-bg { background: rgba(0,0,0,0.8); pointer-events: auto; flex-direction: column; }
    .gacha-item { font-size: 120px; animation: stamp 0.8s ease-out forwards; position: relative; width: 150px; height: 150px; }
    .gacha-item.R::after { content: 'âœ¨'; position: absolute; font-size: 60px; top: -20px; right: -20px; animation: spin 3s linear infinite; }
    .gacha-item.SR::after { content: 'ğŸŒŸ'; position: absolute; font-size: 80px; top: -30px; right: -30px; animation: spin 2s linear infinite; }
    .gacha-title { color: white; font-size: 30px; margin-bottom: 20px; font-weight: bold; text-shadow: 0 0 10px gold; animation: bounce 0.5s infinite; }
    @keyframes spin { 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // --- 100ç¨®é¡ã®ç‰¹å¤§ãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚·ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿ (N:60, R:30, SR:10) ---
    const ALL_STICKERS = [
      // Normal (N) - 60å€‹
      "ğŸ¶","ğŸ±","ğŸ­","ğŸ¹","ğŸ°","ğŸ¦Š","ğŸ»","ğŸ¼","ğŸ¨","ğŸ¯",
      "ğŸ¦","ğŸ®","ğŸ·","ğŸ¸","ğŸµ","ğŸ”","ğŸ§","ğŸ¦","ğŸ¤","ğŸ¦†",
      "ğŸ¦…","ğŸ¦‰","ğŸ¦‡","ğŸº","ğŸ—","ğŸ´","ğŸ¦„","ğŸ","ğŸ›","ğŸ¦‹",
      "ğŸŒ","ğŸ","ğŸœ","ğŸ¢","ğŸ","ğŸ™","ğŸ¦‘","ğŸ¦","ğŸ¦","ğŸ¦€",
      "ğŸ¡","ğŸ ","ğŸŸ","ğŸ¬","ğŸ³","ğŸ‹","ğŸ¦ˆ","ğŸŠ","ğŸ…","ğŸ†",
      "ğŸ","ğŸŒ","ğŸ‡","ğŸ“","ğŸ‰","ğŸŠ","ğŸ‹","ğŸˆ","ğŸ’","ğŸ‘",
      // Rare (R) - 30å€‹
      "ğŸ”","ğŸ•","ğŸŒ­","ğŸ¥ª","ğŸŒ®","ğŸŒ¯","ğŸ¥—","ğŸ¥˜","ğŸ¥«","ğŸ",
      "ğŸœ","ğŸ²","ğŸ›","ğŸ£","ğŸ±","ğŸ¥Ÿ","ğŸ¤","ğŸ™","ğŸš","ğŸ˜",
      "ğŸš—","ğŸš•","ğŸš™","ğŸšŒ","ğŸš","ğŸï¸","ğŸš“","ğŸš‘","ğŸš’","ğŸš",
      // Super Rare (SR) - 10å€‹
      "ğŸš€","ğŸ›¸","ğŸ›°ï¸","ğŸ‘‘","ğŸ’","ğŸ†","ğŸ…","ğŸ‰","ğŸ‘½","ğŸ‘»"
    ].map((char, i) => {
      let rarity = 'N';
      if (i >= 60 && i < 90) rarity = 'R'; 
      if (i >= 90) rarity = 'SR';          
      return { id: i, char, rarity };
    });

    // --- Web Audio API (éŸ³) ---
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    let audioCtx;
    const playTone = (freq, type, duration, startTimeOffset, vol=0.1) => {
      if (!audioCtx) audioCtx = new AudioContext();
      if (audioCtx.state === 'suspended') audioCtx.resume();
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = type; osc.frequency.setValueAtTime(freq, audioCtx.currentTime + startTimeOffset);
      gain.gain.setValueAtTime(vol, audioCtx.currentTime + startTimeOffset);
      gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + startTimeOffset + duration);
      osc.connect(gain); gain.connect(audioCtx.destination);
      osc.start(audioCtx.currentTime + startTimeOffset); osc.stop(audioCtx.currentTime + startTimeOffset + duration);
    };

    const sounds = {
      click: () => playTone(800, 'sine', 0.05, 0),
      tick: () => playTone(1200, 'square', 0.02, 0, 0.05),
      correct: () => { playTone(523.25, 'sine', 0.1, 0); playTone(659.25, 'sine', 0.1, 0.1); playTone(783.99, 'sine', 0.3, 0.2); },
      wrong: () => { playTone(150, 'sawtooth', 0.3, 0); playTone(150, 'sawtooth', 0.3, 0.4); },
      gachaN: () => { playTone(440, 'square', 0.1, 0); playTone(554.37, 'square', 0.1, 0.1); playTone(659.25, 'square', 0.3, 0.2); },
      gachaSR: () => { 
        [523, 587, 659, 698, 783, 880, 987, 1046].forEach((f, i) => playTone(f, 'sine', 0.1, i*0.05));
        playTone(1046, 'square', 0.5, 0.4); 
      },
      timeAttack: () => playTone(880, 'sine', 0.1, 0)
    };

    // --- è£œåŠ©é–¢æ•° ---
    const calcTime = (totalMinutes) => {
      while (totalMinutes < 0) totalMinutes += 24 * 60;
      const h24 = Math.floor(totalMinutes / 60) % 24;
      const h12 = h24 % 12 === 0 ? 12 : h24 % 12;
      const m = totalMinutes % 60;
      return { h12, h24, m };
    };

    const getBgClass = (totalMinutes) => {
      const { h24 } = calcTime(totalMinutes);
      if (h24 >= 5 && h24 < 9) return 'bg-morning';
      if (h24 >= 9 && h24 < 16) return 'bg-day';
      if (h24 >= 16 && h24 < 19) return 'bg-sunset';
      return 'bg-night';
    };

    // --- ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ ---
    const Clock = ({ totalMinutes, showHint }) => {
      const hourAngle = totalMinutes * 0.5;
      const minuteAngle = totalMinutes * 6;
      return (
        <div className="clock-container">
          <svg viewBox="0 0 100 100" width="100%" height="100%">
            <circle cx="50" cy="50" r="48" fill="white" stroke="#ffb8b8" strokeWidth="4" />
            {[...Array(12)].map((_, i) => {
              const num = i + 1;
              const angle = (num * 30 - 90) * (Math.PI / 180);
              const x = 50 + 32 * Math.cos(angle);
              const y = 50 + 32 * Math.sin(angle);
              return <text key={num} x={x} y={y} fontSize="10" fill="#ff6b6b" fontWeight="bold" textAnchor="middle" dominantBaseline="central">{num}</text>;
            })}
            {showHint && [...Array(12)].map((_, i) => {
              const num = i === 0 ? 60 : i * 5;
              const angle = (i * 30 - 90) * (Math.PI / 180);
              const x = 50 + 44 * Math.cos(angle);
              const y = 50 + 44 * Math.sin(angle);
              return <text key={`h-${num}`} x={x} y={y} className="clock-hint" textAnchor="middle" dominantBaseline="central">{num}</text>;
            })}
            {[...Array(60)].map((_, i) => {
              if (i % 5 === 0) return null;
              const angle = (i * 6 - 90) * (Math.PI / 180);
              return <circle key={`dot-${i}`} cx={50 + 42 * Math.cos(angle)} cy={50 + 42 * Math.sin(angle)} r="0.5" fill="#a0d2eb" />;
            })}
            <line className="clock-hand" x1="50" y1="50" x2="50" y2="28" stroke="#ff6b6b" strokeWidth="4" strokeLinecap="round" transform={`rotate(${hourAngle} 50 50)`} />
            <line className="clock-hand" x1="50" y1="50" x2="50" y2="16" stroke="#4ecdc4" strokeWidth="3" strokeLinecap="round" transform={`rotate(${minuteAngle} 50 50)`} />
            <circle cx="50" cy="50" r="3" fill="#333" />
          </svg>
        </div>
      );
    };

    const Numpad = ({ onSubmit }) => {
      const [activeField, setActiveField] = useState('H');
      const [h, setH] = useState('');
      const [m, setM] = useState('');

      const handleKey = (key) => {
        sounds.tick();
        if (key === 'C') {
          if (activeField === 'H') setH(''); else setM('');
          return;
        }
        
        if (activeField === 'H') {
          const newVal = h + String(key);
          if (parseInt(newVal) <= 12) {
            setH(newVal);
            // 10ãƒ»11ãƒ»12 å¯¾å¿œï¼ˆ2ã‚±ã‚¿å…¥åŠ›ã‹ã€2ã€œ9ãŒå…¥åŠ›ã•ã‚ŒãŸã‚‰ã€Œãµã‚“ã€ã¸ç§»å‹•ï¼‰
            if (newVal.length === 2 || (newVal.length === 1 && parseInt(newVal) >= 2)) {
              setActiveField('M');
            }
          }
        } else {
          const newVal = m + String(key);
          // 2ã‚±ã‚¿åˆ¶é™ ï¼† 59ä»¥ä¸‹ã®ã¿å…¥åŠ›å¯èƒ½ï¼ˆã“ã‚Œã§ 0 ã§ã‚‚ 00 ã§ã‚‚OKã€000ã¯é˜²ã’ã‚‹ï¼‰
          if (newVal.length <= 2 && parseInt(newVal) <= 59) {
            setM(newVal);
          }
        }
      };

      return (
        <div className="numpad-container">
          <div className="input-display">
            <div className={`input-box ${activeField === 'H' ? 'active' : ''}`} onClick={() => setActiveField('H')}>{h}</div> ã˜
            <div className={`input-box ${activeField === 'M' ? 'active' : ''}`} onClick={() => setActiveField('M')}>{m}</div> ãµã‚“
          </div>
          <div className="numpad-grid">
            {[1,2,3,4,5,6,7,8,9].map(n => <button key={n} className="num-key" onClick={() => handleKey(n)}>{n}</button>)}
            <button className="num-key action" onClick={() => handleKey('C')}>C</button>
            <button className="num-key" onClick={() => handleKey(0)}>0</button>
            <button className="num-key action" onClick={() => setActiveField(activeField === 'H'?'M':'H')}>â†’</button>
            <button className="num-key submit" onClick={() => onSubmit(parseInt(h||0), parseInt(m||0))}>ã“ã‚Œã ï¼</button>
          </div>
        </div>
      );
    };

    // --- ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒª ---
    function App() {
      const [view, setView] = useState('home');
      const [bgMode, setBgMode] = useState('bg-day');
      const [gears, setGears] = useState(() => parseInt(localStorage.getItem('gears')) || 0);
      const [unlockedStickers, setUnlockedStickers] = useState(() => JSON.parse(localStorage.getItem('unlockedStickers')) || []);
      const [combo, setCombo] = useState(0);
      const [mistakes, setMistakes] = useState(0);
      
      const [modeParams, setModeParams] = useState(null);
      const [question, setQuestion] = useState(null);
      const [message, setMessage] = useState('');
      const [showSuccess, setShowSuccess] = useState(false);
      const [showHint, setShowHint] = useState(false);
      const [interactiveMins, setInteractiveMins] = useState(0);
      const [gachaResult, setGachaResult] = useState(null);
      
      const [timeLeft, setTimeLeft] = useState(0);
      const [score, setScore] = useState(0);
      const timerRef = useRef(null);

      useEffect(() => {
        localStorage.setItem('gears', gears);
        localStorage.setItem('unlockedStickers', JSON.stringify(unlockedStickers));
      }, [gears, unlockedStickers]);

      useEffect(() => {
        if (view === 'home' || view === 'notebook') setBgMode('bg-day');
        else if (question) setBgMode(getBgClass(question.displayMinutes));
      }, [view, question]);

      const triggerSuccess = () => {
        sounds.correct();
        setShowSuccess(true);
        setTimeout(() => setShowSuccess(false), 1200);
      };

      const addReward = (amount) => {
        let earned = amount;
        const newCombo = combo + 1;
        setCombo(newCombo);
        if (newCombo > 0 && newCombo % 3 === 0) {
          earned += 1;
          setMessage(`å¤§ã›ã„ã‹ã„ï¼ğŸ”¥3ã‚³ãƒ³ãƒœãƒœãƒ¼ãƒŠã‚¹ï¼ (+${earned}âš™ï¸)`);
        } else {
          setMessage(`å¤§ã›ã„ã‹ã„ï¼ (+${earned}âš™ï¸)`);
        }
        setGears(g => g + earned);
        triggerSuccess();
      };

      const handleMistake = () => {
        sounds.wrong();
        setCombo(0);
        const newMistakes = mistakes + 1;
        if (newMistakes >= 3 && view !== 'time-attack') {
          setGears(g => Math.max(0, g - 1));
          setMistakes(0);
          setMessage('3ã‹ã„ãƒŸã‚¹â€¦ âš™ï¸1ã“ ã¼ã£ã—ã‚…ã†ğŸ˜­ ã¹ã¤ã®ã‚‚ã‚“ã ã„ã«ã™ã‚‹ã­');
          setTimeout(() => generateQuestion(modeParams), 2000);
        } else {
          setMistakes(newMistakes);
          setMessage(`ã–ã‚“ã­ã‚“ï¼ (${newMistakes}ã‹ã„ ãƒŸã‚¹)`);
        }
      };

      // --- å•é¡Œç”Ÿæˆ ---
      const generateQuestion = (params) => {
        setShowHint(false);
        const { type, lv } = params;
        
        // æ¯å›æ–°ã—ã„idã‚’æŒ¯ã‚‹ã“ã¨ã§ã€ãƒ†ãƒ³ã‚­ãƒ¼ã‚’ç¢ºå®Ÿã«ãƒªã‚»ãƒƒãƒˆ
        let q = { displayMinutes: 0, id: Math.random() };
        const h = Math.floor(Math.random() * 12) + 1;

        if (type === 'read') {
          let m = 0;
          if (lv === 0) m = Math.random() < 0.5 ? 0 : 30;
          else m = Math.floor(Math.random() * 12) * 5;
          
          const totalM = h * 60 + m;
          q.displayMinutes = totalM;
          q.correctH = calcTime(totalM).h12;
          q.correctM = calcTime(totalM).m;
          
          if (lv === 0 || lv === 1) {
            const wrong1 = calcTime(totalM + (lv===0?30:15));
            const wrong2 = calcTime(totalM + 60);
            q.choices = [
              { h: q.correctH, m: q.correctM },
              { h: wrong1.h12, m: wrong1.m },
              { h: wrong2.h12, m: q.correctM }
            ].sort(() => Math.random() - 0.5);
          }
          setMessage(lv === 0 ? 'ãªã‚“ã˜ ãªã‚“ã·ã‚“ï¼Ÿ(ã‚„ã•ã—ã„)' : 'ãªã‚“ã˜ ãªã‚“ã·ã‚“ ã‹ãªï¼Ÿ');
        } 
        else if (type === 'move') {
          const startTotal = h * 60 + (Math.floor(Math.random() * 4) * 15);
          const offsets = [10, 15, 20, 30, 60, -10, -15, -20, -30, -60];
          const offset = offsets[Math.floor(Math.random() * offsets.length)];
          q.displayMinutes = startTotal;
          q.offset = offset;
          q.targetTotal = startTotal + offset;
          q.correctH = calcTime(q.targetTotal).h12;
          q.correctM = calcTime(q.targetTotal).m;
          setInteractiveMins(startTotal);
          
          const st = calcTime(startTotal);
          let text = offset > 0 ? `${offset}ã·ã‚“ ã”` : `${Math.abs(offset)}ã·ã‚“ ã¾ãˆ`;
          if(offset === 60) text = "1ã˜ã‹ã‚“ ã”"; if(offset === -60) text = "1ã˜ã‹ã‚“ ã¾ãˆ";
          setMessage(`ã„ã¾ ${st.h12}ã˜${st.m}ãµã‚“ã€‚ã€Œ${text}ã€ã¯ ãªã‚“ã˜ï¼Ÿ`);
        }

        setQuestion(q);
      };

      const startGame = (type, lv, reward) => {
        sounds.click();
        const params = { type, lv, reward };
        setModeParams(params);
        setMistakes(0);
        setCombo(0);
        generateQuestion(params);
        setView('game');
      };

      const checkReadLv1 = (ansH, ansM) => {
        if (ansH === question.correctH && ansM === question.correctM) {
          addReward(modeParams.reward);
          setMistakes(0);
          setTimeout(() => generateQuestion(modeParams), 1500);
        } else handleMistake();
      };

      const checkNumpad = (h, m) => {
        if (h === question.correctH && m === question.correctM) {
          addReward(modeParams.reward);
          setMistakes(0);
          setTimeout(() => generateQuestion(modeParams), 1500);
        } else handleMistake();
      };

      const checkMoveLv1 = () => {
        if ((interactiveMins % 720 + 720) % 720 === (question.targetTotal % 720 + 720) % 720) {
          addReward(modeParams.reward);
          setMistakes(0);
          setTimeout(() => generateQuestion(modeParams), 1500);
        } else handleMistake();
      };

      const useHint = () => {
        if (gears >= 1 && !showHint) {
          sounds.click(); setGears(g => g - 1); setShowHint(true);
        }
      };

      // --- ã‚¿ã‚¤ãƒ ã‚¢ã‚¿ãƒƒã‚¯ ---
      const startTimeAttack = () => {
        sounds.click();
        setView('time-attack');
        setScore(0); setTimeLeft(60); setCombo(0);
        generateQuestion({ type: 'read', lv: 2, reward: 0 }); 
        
        if (timerRef.current) clearInterval(timerRef.current);
        timerRef.current = setInterval(() => {
          setTimeLeft(t => {
            if (t <= 1) {
              clearInterval(timerRef.current);
              sounds.gachaSR(); 
              return 0;
            }
            if (t <= 10) sounds.timeAttack(); 
            return t - 1;
          });
        }, 1000);
      };

      const handleTaAnswer = (h, m) => {
        if (h === question.correctH && m === question.correctM) {
          sounds.correct(); setScore(s => s + 1);
          generateQuestion({ type: 'read', lv: 2, reward: 0 });
        } else {
          sounds.wrong();
        }
      };

      const spinGacha = () => {
        if (gears >= 10) {
          setGears(g => g - 10);
          const r = Math.random();
          let targetRarity = 'N';
          if (r > 0.7 && r <= 0.95) targetRarity = 'R';
          if (r > 0.95) targetRarity = 'SR';
          
          const pool = ALL_STICKERS.filter(s => s.rarity === targetRarity);
          const sticker = pool[Math.floor(Math.random() * pool.length)];
          
          if (!unlockedStickers.includes(sticker.id)) {
            setUnlockedStickers([...unlockedStickers, sticker.id]);
          }
          
          if (targetRarity === 'SR') sounds.gachaSR();
          else sounds.gachaN();
          
          setGachaResult(sticker);
        } else sounds.wrong();
      };

      const resetGame = () => {
        if(confirm("ã»ã‚“ã¨ã†ã« ãƒ‡ãƒ¼ã‚¿ã‚’ ãœã‚“ã¶ ã‘ã—ã¾ã™ã‹ï¼Ÿ")) {
          localStorage.clear();
          setGears(0); setUnlockedStickers([]);
          sounds.click();
        }
      };

      return (
        <div className={`app-container ${bgMode}`}>
          {showSuccess && <div className="overlay"><div className="hanamaru">ğŸ’®</div></div>}
          
          {gachaResult && (
            <div className="overlay gacha-bg">
              <div className="gacha-title">{gachaResult.rarity === 'SR' ? 'è¶…ãƒ»å¤§ã‚¢ã‚¿ãƒªï¼ï¼' : gachaResult.rarity === 'R' ? 'å¤§ã‚¢ã‚¿ãƒªï¼' : 'ã‚·ãƒ¼ãƒ«ã‚²ãƒƒãƒˆï¼'}</div>
              <div className={`sticker gacha-item ${gachaResult.rarity}`}>{gachaResult.char}</div>
              <button className="btn-back" style={{marginTop: '50px', position:'relative', zIndex:10}} onClick={() => {sounds.click(); setGachaResult(null);}}>ã¨ã˜ã‚‹</button>
            </div>
          )}

          <div className="status-bar">
            âš™ï¸ {gears}ã“ {combo > 1 && <span className="combo-text">ğŸ”¥{combo}é€£å‹!</span>}
          </div>
          
          {view === 'home' && (
            <div>
              <h1>ã˜ã‹ã‚“ãŸã‚“ã¦ã„</h1>
              <div className="menu-grid">
                <button className="menu-btn btn-easy" onClick={() => startGame('read', 0, 1)}>ğŸ£ ã‚„ã•ã—ã„<br/><small>(âš™ï¸1)</small></button>
                <button className="menu-btn btn-read1" onClick={() => startGame('read', 1, 1)}>ğŸ¥‰ ã‚ˆã‚€ Lv1<br/><small>(3æŠ/âš™ï¸1)</small></button>
                <button className="menu-btn btn-read2" onClick={() => startGame('read', 2, 2)}>ğŸ¥ˆ ã‚ˆã‚€ Lv2<br/><small>(æ•°å­—/âš™ï¸2)</small></button>
                <button className="menu-btn btn-move1" onClick={() => startGame('move', 1, 3)}>ğŸ¥‡ ãƒˆãƒ©ãƒ™ãƒ« Lv1<br/><small>(æ™‚è¨ˆ/âš™ï¸3)</small></button>
                <button className="menu-btn btn-move2" onClick={() => startGame('move', 2, 4)}>ğŸ† ãƒˆãƒ©ãƒ™ãƒ« Lv2<br/><small>(æ•°å­—/âš™ï¸4)</small></button>
                <button className="menu-btn btn-attack" onClick={startTimeAttack}>â° ã‚¿ã‚¤ãƒ ã‚¢ã‚¿ãƒƒã‚¯</button>
                {/* ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºã‚’100å€‹ã« */}
                <button className="menu-btn btn-book" onClick={() => { sounds.click(); setView('notebook'); setMessage(''); }}>ğŸ“– ã‚·ãƒ¼ãƒ«ã¦ã¡ã‚‡ã† ({unlockedStickers.length}/100)</button>
                <button className="menu-btn btn-reset" onClick={resetGame}>ã•ã„ã—ã‚‡ã‹ã‚‰ (ãƒªã‚»ãƒƒãƒˆ)</button>
              </div>
            </div>
          )}

          {view === 'game' && question && (
            <div>
              <div className="message-box">{message}</div>
              
              <Clock totalMinutes={modeParams.type === 'move' ? interactiveMins : question.displayMinutes} showHint={showHint} />
              
              {modeParams.type === 'move' && (
                <div className="controls">
                  <button className="control-btn" onClick={() => { sounds.tick(); setInteractiveMins(p=>p-60); }}>âª 1ã˜ã‹ã‚“</button>
                  <button className="control-btn" onClick={() => { sounds.tick(); setInteractiveMins(p=>p-5); }}>â— 5ãµã‚“</button>
                  <button className="control-btn" onClick={() => { sounds.tick(); setInteractiveMins(p=>p+5); }}>5ãµã‚“ â–·</button>
                  <button className="control-btn" onClick={() => { sounds.tick(); setInteractiveMins(p=>p+60); }}>1ã˜ã‹ã‚“ â©</button>
                </div>
              )}

              {!showHint && gears >= 1 && (
                <button className="btn-hint" onClick={useHint}>ğŸ’¡ ãƒ’ãƒ³ãƒˆã‚’ã¿ã‚‹ (âš™ï¸1)</button>
              )}

              {/* å›ç­”UI */}
              {modeParams.type === 'read' && modeParams.lv <= 1 && question.choices && (
                <div className="choices">
                  {question.choices.map((c, i) => (
                    <button
                      key={i}
                      className="choice-btn"
                      onClick={() => { sounds.click(); checkReadLv1(c.h, c.m); }}
                    >
                      {c.h}ã˜ {c.m}ãµã‚“
                    </button>
                  ))}
                </div>
              )}

              {/* æ¯å›ãƒªã‚»ãƒƒãƒˆã•ã‚Œã‚‹ãƒ†ãƒ³ã‚­ãƒ¼ (ã‚ˆã‚€ Lv2) */}
              {modeParams.type === 'read' && modeParams.lv >= 2 && (
                <Numpad
                  key={question.id}
                  onSubmit={(h, m) => { sounds.click(); checkNumpad(h, m); }}
                />
              )}

              {modeParams.type === 'move' && modeParams.lv === 1 && (
                <button
                  className="choice-btn"
                  onClick={() => { sounds.click(); checkMoveLv1(); }}
                >
                  ã“ã‚Œã ï¼
                </button>
              )}

              {/* æ¯å›ãƒªã‚»ãƒƒãƒˆã•ã‚Œã‚‹ãƒ†ãƒ³ã‚­ãƒ¼ (ãƒˆãƒ©ãƒ™ãƒ« Lv2) */}
              {modeParams.type === 'move' && modeParams.lv >= 2 && (
                <Numpad
                  key={question.id}
                  onSubmit={(h, m) => { sounds.click(); checkNumpad(h, m); }}
                />
              )}

              <button
                className="btn-back"
                onClick={() => { sounds.click(); setView('home'); }}
              >
                ã‚‚ã©ã‚‹
              </button>
            </div>
          )}

          {/* ã‚¿ã‚¤ãƒ ã‚¢ã‚¿ãƒƒã‚¯ */}
          {view === 'time-attack' && question && (
            <div>
              <div className="message-box">
                ã®ã“ã‚Š {timeLeft}ã³ã‚‡ã†ã€€ã‚¹ã‚³ã‚¢ {score}
              </div>

              <Clock totalMinutes={question.displayMinutes} showHint={false} />

              {timeLeft > 0 ? (
                {/* æ¯å›ãƒªã‚»ãƒƒãƒˆã•ã‚Œã‚‹ãƒ†ãƒ³ã‚­ãƒ¼ (ã‚¿ã‚¤ãƒ ã‚¢ã‚¿ãƒƒã‚¯) */}
                <Numpad key={question.id} onSubmit={handleTaAnswer} />
              ) : (
                <div>
                  <div className="message-box">
                    ãŠã‚ã‚Šï¼ ã‚¹ã‚³ã‚¢ {score}
                  </div>
                  <button
                    className="menu-btn btn-attack"
                    onClick={() => {
                      sounds.click();
                      const reward = Math.floor(score / 3);
                      setGears(g => g + reward);
                      setView('home');
                    }}
                  >
                    ã»ã†ã—ã‚…ã†ã‚’ã‚‚ã‚‰ã† (âš™ï¸{Math.floor(score / 3)})
                  </button>
                </div>
              )}

              <button
                className="btn-back"
                onClick={() => { sounds.click(); setView('home'); }}
              >
                ã‚„ã‚ã‚‹
              </button>
            </div>
          )}

          {/* ã‚·ãƒ¼ãƒ«ã¦ã¡ã‚‡ã† */}
          {view === 'notebook' && (
            <div>
              <h1>ã‚·ãƒ¼ãƒ«ã¦ã¡ã‚‡ã†</h1>

              <div className="notebook">
                <p style={{margin: '0 0 10px 0', fontWeight: 'bold'}}>ã‚ã¤ã‚ãŸæ•°: {unlockedStickers.length} / 100</p>
                <div className="sticker-grid">
                  {ALL_STICKERS.map((s) => {
                    const unlocked = unlockedStickers.includes(s.id);
                    return (
                      <div
                        key={s.id}
                        className={`sticker ${unlocked ? s.rarity : 'locked-sticker'}`}
                      >
                        {unlocked ? s.char : "ï¼Ÿ"}
                      </div>
                    );
                  })}
                </div>
              </div>

              <button
                className="menu-btn btn-book"
                onClick={spinGacha}
                disabled={gears < 10}
                style={{marginTop: '15px'}}
              >
                {gears >= 10 ? 'ğŸ² ã‚¬ãƒãƒ£ã‚’ã²ã (âš™ï¸10)' : 'âš™ï¸ãŒ ãŸã‚Šãªã„ã‚ˆ'}
              </button>

              <button
                className="btn-back"
                onClick={() => { sounds.click(); setView('home'); }}
              >
                ã‚‚ã©ã‚‹
              </button>
            </div>
          )}
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
